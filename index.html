<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Tripit Pakistan – Bookings & Profit Tracker</title>
  <style>
    :root { --gap: 10px; --radius: 10px; --bg: #121212; --card: #1e1e1e; --text: #e0e0e0; --muted: #888; --accent: #4da6ff; --accent-hover: #3399ff; --error: #ff5c5c; --border: #333; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 20px; background: var(--bg); color: var(--text); }
    h1, h2, h3 { color: var(--text); }
    section { background: var(--card); border: 1px solid var(--border); border-radius: var(--radius); padding: 16px; margin-bottom: 18px; }
    label { display:block; font-weight: 600; margin-top: 8px; }
    input, select, textarea, button { padding: 8px; border-radius: 8px; border: 1px solid var(--border); width: 100%; box-sizing: border-box; background: #222; color: var(--text); }
    input::placeholder, textarea::placeholder { color: var(--muted); }
    button { background: var(--accent); color: #fff; border: none; cursor: pointer; }
    button:hover { background: var(--accent-hover); }
    .row { display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap: var(--gap); }
    .actions { display:flex; gap: var(--gap); flex-wrap: wrap; margin-top: 12px; }
    table { width: 100%; border-collapse: collapse; margin-top: 12px; background: var(--card); }
    th, td { border: 1px solid var(--border); padding: 8px; text-align: left; vertical-align: middle; }
    th { background: #222; color: var(--text); }
    .muted { color: var(--muted); }
    .ok { color: var(--accent); font-weight: 600; }
    .err { color: var(--error); font-weight: 600; }
    .inline { display:inline-block; width:auto; }
    .hidden { display: none; }
    .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.7); display:none; align-items:center; justify-content:center; }
    .modal .box { background: var(--card); padding: 16px; width: min(520px, 90vw); border-radius: var(--radius); color: var(--text); }
    .box h3 { margin-top: 0; }
    .icon-btn{ background: transparent; border: 1px solid var(--border); padding: 6px; border-radius: 8px; }
    .icon{ width: 18px; height: 18px; display:block; }
    .edit-row{ border-color: var(--accent); }
  </style>
</head>
<body>
  <h1>Tripit Pakistan – Bookings & Profit Tracker</h1>

  <section id="add-booking">
    <h2>Add / Edit Booking</h2>
    <div id="editing-banner" class="hidden muted">Editing… <button id="btn-cancel-edit" class="inline">Cancel</button></div>
    <div class="row">
      <div><label>Date</label><input type="date" id="bk-date" required /></div>
      <div><label>Client Name</label><input type="text" id="bk-name" required /></div>
      <div><label>Contact Number</label><input type="text" id="bk-contact" required /></div>
      <div><label>CNIC (Optional)</label><input type="text" id="bk-cnic" /></div>
      <div><label>Adults</label><select id="bk-adults"></select></div>
      <div><label>Kids</label><select id="bk-kids"></select></div>
      <div><label>Category</label>
        <select id="bk-category">
          <option value="Family">Family</option>
          <option value="Couple">Couple</option>
          <option value="Boys">Boys</option>
        </select>
      </div>
      <div><label>Trip</label><input type="text" id="bk-trip" placeholder="Kashmir, Hunza, etc." required /></div>
      <div><label>Total Paid Amount (PKR)</label><input type="number" id="bk-paid" step="0.01" value="0" required /></div>
      <div><label>Total B2B Amount (PKR)</label><input type="number" id="bk-b2b" step="0.01" value="0" required /></div>
      <div><label>Total Remaining Amount (PKR)</label><input type="number" id="bk-remaining" step="0.01" value="0" required /></div>
      <div><label>Booked</label><input type="checkbox" id="bk-booked" /></div>
      <div><label>Booked By</label><input type="text" id="bk-bookedby" placeholder="Agent name" /></div>
      <div style="grid-column: 1 / -1"><label>Notes</label><textarea id="bk-notes" rows="1" placeholder="Optional notes"></textarea></div>
    </div>
    <div class="actions">
      <button id="btn-save-booking" class="inline">Save Booking</button>
      <div id="msg-booking" class="muted"></div>
    </div>
  </section>

  <section id="add-expense">
    <h2>Add Expense</h2>
    <div class="row">
      <div><label>Expense</label><input type="text" id="ex-title" placeholder="e.g., Fuel, Hotel advance" required /></div>
      <div><label>Amount (PKR)</label><input type="number" id="ex-amount" step="0.01" value="0" required /></div>
    </div>
    <div class="actions">
      <button id="btn-save-expense" class="inline">Add Expense</button>
      <div id="msg-expense" class="muted"></div>
    </div>
  </section>

  <section id="show-all">
    <h2>Show All Bookings (sorted by date)</h2>
    <div class="row">
      <div><label>Password (to reveal B2B, Remaining, Profit, Contact, CNIC)</label><input type="password" id="pw" placeholder="Enter admin password" /></div>
    </div>
    <div class="actions">
      <button id="btn-load">Show Bookings</button>
      <button id="btn-unlock">Unlock Sensitive Fields</button>
      <div id="msg-list" class="muted"></div>
    </div>
    <div style="overflow:auto">
      <table id="tbl">
        <thead></thead>
        <tbody></tbody>
      </table>
    </div>
  </section>

  <section id="profits">
    <h2>Monthly Profit vs. Expense</h2>
    <div class="actions"><button id="btn-check-profits">Check Profits</button></div>
  </section>

  <!-- Modal for Profit Check -->
  <div class="modal" id="modal">
    <div class="box">
      <h3>Check Profits</h3>
      <div class="row">
        <div><label>Month</label><select id="m-month"></select></div>
        <div><label>Year</label><input type="number" id="m-year" value="2025" /></div>
        <div><label>Password</label><input type="password" id="m-pw" placeholder="Admin password" /></div>
      </div>
      <div class="actions">
        <button id="btn-run-summary">Run</button>
        <button id="btn-close">Close</button>
        <div id="msg-summary" class="muted"></div>
      </div>
      <div id="summary-out"></div>
    </div>
  </div>

<script>
  // ==== CONFIG ====
  const API_BASE = 'YOUR_WEB_APP_URL'; // e.g. https://script.google.com/macros/s/AKfycbx.../exec
  let memorizedPassword = ''; // set to 'yourStrongPW' if you prefer not to type
  let currentEditId = null; // when set, Save will update instead of add
  let authorizedView = false; // track if table is showing unlocked data

  // ==== HELPERS ====
  function $(id){ return document.getElementById(id); }
  function num(v){ const n = parseFloat(v); return isNaN(n) ? 0 : n; }
  function toast(el, msg, ok=true){ el.className = ok ? 'ok' : 'err'; el.textContent = msg; setTimeout(()=>{ el.className='muted'; }, 3000); }
  function fmtPKR(n){ return new Intl.NumberFormat('en-PK', { style:'currency', currency:'PKR', maximumFractionDigits:0 }).format(n); }
  function fillSelectNums(selId, max=20){ const el = $(selId); el.innerHTML=''; for (let i=0;i<=max;i++){ const o=document.createElement('option'); o.value=i; o.textContent=i; el.appendChild(o);} }
  function fillMonths(selId){ const names=['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec']; const el=$(selId); names.forEach((n,i)=>{ const o=document.createElement('option'); o.value=i+1; o.textContent=n; el.appendChild(o); }); const now=new Date(); el.value=now.getMonth()+1; }
  function clearForm(){ ['bk-date','bk-name','bk-contact','bk-cnic','bk-trip','bk-paid','bk-b2b','bk-remaining','bk-notes','bk-bookedby'].forEach(id=>$(id).value=''); $('bk-adults').value=0; $('bk-kids').value=0; $('bk-category').value='Family'; $('bk-booked').checked=false; currentEditId=null; $('editing-banner').classList.add('hidden'); }

  // ==== INIT ====
  fillSelectNums('bk-adults', 20); fillSelectNums('bk-kids', 20); fillMonths('m-month');
  $('btn-cancel-edit').addEventListener('click', clearForm);

  // ==== ADD/UPDATE BOOKING ====
  $('btn-save-booking').addEventListener('click', async ()=>{
    const payload = {
      id: currentEditId,
      date: $('bk-date').value,
      clientName: $('bk-name').value,
      contact: $('bk-contact').value,
      cnic: $('bk-cnic').value,
      adults: $('bk-adults').value,
      kids: $('bk-kids').value,
      category: $('bk-category').value,
      trip: $('bk-trip').value,
      totalPaid: num($('bk-paid').value),
      b2b: num($('bk-b2b').value),
      remaining: num($('bk-remaining').value),
      booked: $('bk-booked').checked,
      bookedBy: $('bk-bookedby').value,
      notes: $('bk-notes').value
    };
    if (!payload.date || !payload.clientName || !payload.contact || !payload.trip){ toast($('msg-booking'),'Please fill Date, Client Name, Contact, and Trip.', false); return; }
    try {
      const action = currentEditId ? 'updateBooking' : 'addBooking';
      const res = await fetch(API_BASE, { method:'POST', headers:{ 'Content-Type':'text/plain' }, body: JSON.stringify({ action, payload }) });
      const json = await res.json();
      if (json.ok){ toast($('msg-booking'), currentEditId ? 'Booking updated.' : 'Booking saved.'); if (!currentEditId) currentEditId = json.id || null; clearForm(); refreshList(); }
      else { toast($('msg-booking'), json.error||'Error', false); }
    } catch(err){ toast($('msg-booking'), err.message||String(err), false); }
  });

  // ==== ADD EXPENSE ====
  $('btn-save-expense').addEventListener('click', async ()=>{
    const payload = { expense: $('ex-title').value, amount: num($('ex-amount').value) };
    if (!payload.expense){ toast($('msg-expense'), 'Enter an expense name.', false); return; }
    try {
      const res = await fetch(API_BASE, { method:'POST', headers:{ 'Content-Type':'text/plain' }, body: JSON.stringify({ action:'addExpense', payload }) });
      const json = await res.json(); if (json.ok){ toast($('msg-expense'),'Expense saved.'); } else { toast($('msg-expense'), json.error||'Error', false); }
    } catch(err){ toast($('msg-expense'), err.message||String(err), false); }
  });

  // ==== TABLE RENDER ====
  function renderTable(items){
    const thead = $('tbl').querySelector('thead'); const tbody = $('tbl').querySelector('tbody'); thead.innerHTML=''; tbody.innerHTML='';
    if (!items || !items.length){ thead.innerHTML = '<tr><th>No data</th></tr>'; return; }
    const cols = Object.keys(items[0]).filter(k=>k!=='id');
    const trh = document.createElement('tr'); cols.concat(['Actions']).forEach(c=>{ const th=document.createElement('th'); th.textContent=c; trh.appendChild(th); }); thead.appendChild(trh);
    items.forEach(r=>{
      const tr=document.createElement('tr'); tr.dataset.id = r.id;
      cols.forEach(c=>{
        const td=document.createElement('td'); let v=r[c];
        if (['totalPaid','b2b','remaining','profit'].includes(c) && typeof v==='number') v = fmtPKR(v);
        if (c==='booked') v = r.booked ? '✓' : '—';
        td.textContent = v; tr.appendChild(td);
      });
      const tdAct=document.createElement('td');
      tdAct.innerHTML = `
        <button class="icon-btn" data-act="edit" title="Edit">
          <svg class="icon" viewBox="0 0 24 24"><path fill="currentColor" d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04a1.003 1.003 0 0 0 0-1.42l-2.34-2.34a1.003 1.003 0 0 0-1.42 0l-1.83 1.83 3.75 3.75 1.84-1.82z"/></svg>
        </button>
        <button class="icon-btn" data-act="del" title="Delete">
          <svg class="icon" viewBox="0 0 24 24"><path fill="currentColor" d="M6 7h12v2H6V7zm2 3h8l-1 10H9L8 10zm3-6h2v2h-2V4z"/></svg>
        </button>`;
      tr.appendChild(tdAct);
      tbody.appendChild(tr);
    });
  }

  // Row actions
  $('tbl').addEventListener('click', async (e)=>{
    const btn = e.target.closest('button'); if (!btn) return; const tr = e.target.closest('tr'); if (!tr) return; const id = tr.dataset.id; const act = btn.getAttribute('data-act');
    if (act === 'edit'){
      let pw = memorizedPassword || $('pw').value || '';
      if (!pw) pw = prompt('Enter admin password to edit:') || '';
      if (!pw){ toast($('msg-list'),'Password required to edit.', false); return; }
      try {
        const url = `${API_BASE}?action=getbooking&id=${encodeURIComponent(id)}&password=${encodeURIComponent(pw)}`;
        const res = await fetch(url); const json = await res.json();
        if (json.ok && json.item){ const b=json.item; memorizedPassword = pw; authorizedView = json.authorized || authorizedView; fillFormForEdit(b); toast($('msg-list'),'Loaded for editing.'); }
        else { toast($('msg-list'), json.error||'Error', false); }
      } catch(err){ toast($('msg-list'), err.message||String(err), false); }
    }
    if (act === 'del'){
      if (!confirm('Delete this booking?')) return;
      let pw = memorizedPassword || $('pw').value || '';
      if (!pw) pw = prompt('Enter admin password to delete:') || '';
      if (!pw){ toast($('msg-list'),'Password required to delete.', false); return; }
      try {
        const payload = { id, password: pw };
        const res = await fetch(API_BASE, { method:'POST', headers:{ 'Content-Type':'text/plain' }, body: JSON.stringify({ action:'deleteBooking', payload }) });
        const json = await res.json(); if (json.ok){ toast($('msg-list'),'Deleted.'); refreshList(); } else { toast($('msg-list'), json.error||'Error', false); }
      } catch(err){ toast($('msg-list'), err.message||String(err), false); }
    }
  });

  function fillFormForEdit(b){ currentEditId = b.id; $('bk-date').value=b.date||''; $('bk-name').value=b.clientName||''; $('bk-contact').value=(b.contact&&b.contact!=='••••')?b.contact:''; $('bk-cnic').value=(b.cnic&&b.cnic!=='••••')?b.cnic:''; $('bk-adults').value=b.adults||0; $('bk-kids').value=b.kids||0; $('bk-category').value=b.category||'Family'; $('bk-trip').value=b.trip||''; $('bk-paid').value=b.totalPaid||0; $('bk-b2b').value=(typeof b.b2b==='number')?b.b2b:0; $('bk-remaining').value=(typeof b.remaining==='number')?b.remaining:0; $('bk-booked').checked=!!b.booked; $('bk-bookedby').value=b.bookedBy||''; $('bk-notes').value=b.notes||''; $('editing-banner').classList.remove('hidden'); }

  // ==== LIST (MASKED) ====
  $('btn-load').addEventListener('click', async ()=>{ authorizedView=false; try { const res = await fetch(`${API_BASE}?action=listbookings`); const json = await res.json(); if (json.ok){ renderTable(json.items); $('msg-list').textContent = 'Showing masked data'; } else { toast($('msg-list'), json.error||'Error', false); } } catch(err){ toast($('msg-list'), err.message||String(err), false); } });

  // ==== LIST (UNLOCK SENSITIVE) ====
  $('btn-unlock').addEventListener('click', async ()=>{
    const pw = $('pw').value || memorizedPassword || '';
    if (!pw){ toast($('msg-list'), 'Enter password first.', false); return; }
    try {
      const url = `${API_BASE}?action=listbookingsfull&password=${encodeURIComponent(pw)}`;
      const res = await fetch(url); const json = await res.json();
      if (json.ok && json.authorized){ renderTable(json.items); memorizedPassword = pw; authorizedView=true; toast($('msg-list'), 'Unlocked.'); }
      else { toast($('msg-list'), (json.error||'Invalid password'), false); }
    } catch(err){ toast($('msg-list'), err.message||String(err), false); }
  });

  function refreshList(){ if (authorizedView && memorizedPassword){ $('btn-unlock').click(); } else { $('btn-load').click(); } }
</script>
</body>
</html>
